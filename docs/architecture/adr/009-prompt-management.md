# ADR-009: Стратегия управления промптами (Prompt Management)

## Статус
Предложено (Proposed)

## Контекст
В VLMHyperBench v0.2.0 возникает необходимость гибкого управления промптами в зависимости от типа документа (например, паспорт, инвойс, чек) и конкретной модели. Использование жестко заданных промптов в датасете ограничивает возможности оптимизации ответов моделей.

## Решение
Мы внедряем выделенный компонент **PromptManager**, который отвечает за формирование финального промпта на основе метаданных объекта и конфигурации модели.

### 1. Логика разрешения промптов (Resolution Logic)
Для каждого элемента датасета `PromptManager` выбирает промпт, следуя приоритетам:

1.  **Override (Ручное переопределение)**: Если в конфиге запуска для данной модели указан `fixed_prompt` или `fixed_system_prompt`, используется именно он. Это полезно для быстрой отладки или тестирования одного промпта на всем датасете.
2.  **Mapping (Сопоставление по типу)**: Если задан `prompt_collection`, менеджер ищет промпт, соответствующий `doc_type` из метаданных объекта (`item.metadata.doc_type`).
3.  **Fallback (По умолчанию)**: Если специфичных настроек нет, используется значение по умолчанию из описания датасета или пустая строка.

### 2. Структура конфигурации
Пример конфигурации промптов в JSON:

```json
{
  "prompt_config": {
    "system_prompt": "You are a helpful OCR assistant.",
    "type_mapping": {
      "passport": {
        "system_prompt": "You are a specialized passport recognition agent.",
        "user_prompt": "Extract Name, Number, and Date from this passport:"
      },
      "invoice": {
        "user_prompt": "List all items and total amount from this invoice:"
      }
    }
  }
}
```

## Последствия

### Плюсы
- **Гибкость**: Позволяет оптимизировать промпты под конкретные домены документов без изменения самого датасета.
- **Масштабируемость**: Легко добавлять поддержку новых типов документов через обновление конфига.
- **Чистота данных**: Промпты отделены от данных (Ground Truth) и логики инференса.

### Минусы
- Усложнение логики подготовки запроса перед отправкой в API Wrapper.
- Необходимость поддерживать актуальность маппинга типов документов.